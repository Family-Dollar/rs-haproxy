---
driver_plugin: vagrant
driver_config:
  require_chef_omnibus: true
  customize:
    cpus: 2
    memory: 1024
  network:
    - ["private_network", {ip: "192.0.2.2"}]

platforms:
- name: ubuntu-12.04
  run_list: ["recipe[apt]"]
  driver_config:
    box: opscode-ubuntu-12.04
    box_url: https://opscode-vm-bento.s3.amazonaws.com/vagrant/opscode_ubuntu-12.04_provisionerless.box
- name: centos-6.4
  run_list: ["recipe[yum::epel]"]
  driver_config:
    box: opscode-centos-6.4
    box_url: https://opscode-vm-bento.s3.amazonaws.com/vagrant/opscode_centos-6.4_provisionerless.box

# Tests the basic HAProxy configuration, load balancer related machine tags set on the server, and
# the HAProxy collectd monitoring configuration. The HAProxy configuration is verified by ensuring
# the HAProxy parameters in the haproxy.cfg file are set up as expected.
#
suites:
- name: default
  run_list:
  - recipe[rs-haproxy::default]
  - recipe[rs-haproxy::tags]
  - recipe[rs-haproxy::collectd]
  attributes:
    rightscale:
      instance_uuid: '01-ABCDEFGH0123'
    cloud:
      provider: 'vagrant'
      public_ips: ['192.0.2.2']
    rs-haproxy:
      pools: ['app1', 'app2', 'app3', 'default']
      stats_uri: '/haproxy-status'
      stats_user: 'statsuser'
      stats_pass: 'statspass'
      health_check_uri: '/'
      session_stickiness: true
    rightscale:
      instance_uuid: '12345UUID'

# Tests the HAProxy backend configuration by setting up fake application servers and attaching them
# to HAProxy. The tests verify that the application servers are attached to the appropriate backend
# pools served by HAProxy.
#
- name: backend
  run_list:
  - recipe[fake::default]
  - recipe[rs-haproxy::frontend]
  attributes:
    cloud:
      provider: 'vagrant'
      public_ips: ['192.0.2.2']
    rs-haproxy:
      pools: ['app1', 'app2', 'app3', 'default']
      stats_uri: '/haproxy-status'
      stats_user: 'statsuser'
      stats_pass: 'statspass'
      health_check_uri: '/'
      session_stickiness: true
    rightscale:
      instance_uuid: '12345UUID'
